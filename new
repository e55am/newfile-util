#!/usr/bin/env bash
# new -- create new file(s) from predefined template
#
# Author: essam 'https://github.com/e55am'


usage() { echo "Usage: $PROG [-h] <FILEs>"; }


_help() {
	cat <<- __EOF__
	$(usage)

	Create new file from predefined template

	Arguments:
	  FILE		File name to be created

	Option:
	  -h		show this help message and exit

	Exit Status:
	Returns success (0) if all File created; fails (1) if no argument.

	Example:
	Create foo.py and spam.py in current dir
	  $PROG foo.py spam.py

	Create foo.c foo.h at path/to/dir/
	  $PROG path/to/dir/foo.{h,c}

	__EOF__
}


check_templates() {
	# check if template dir exist, if not extract ./template archive

	if ! [[ -d $TEMPLATE_DIR ]]; then
		echo "WARNING: No such \"$TEMPLATE_DIR\" directory" >&2
		read -rp "Do you want to create \"$TEMPLATE_DIR\" directory (y/n)? " choice

		if [[ "${choice:0:1}" == [Yy] ]]; then
			echo "extracting templates"
			extract_templates
		fi
	fi
}


extract_templates() {
	# extract template tar archive

	if [[ -f ./templates ]]; then
		tar -xf ./templates -C "$HOME/"
	fi
}

select_suffix() {
	# select file template from $HOME/Templates dir
	#
	# Arguments: (str)
	# 		$1: filename
	#
	# Returns: (str)
	#		new filename (filename + suffix/extension)
	FILE=$1

	read -rp "extension >> " extension
	if [[ -n $extension ]]; then
		# if first char from suffix isn't '.' (dot)
		# add dot and concatenate file name with suffix
		if [[ ${extension:0:1} == "." ]]; then
			FILE+="$extension"
		else
			FILE+=".$extension"
		fi
	fi

	echo "$FILE"
}


no_template() {
	# if there no predefined template for FILE
	#
	# Return: (int)
	# 		1 if user enter '1' or no input, to create plain text file
	# 		2 if user want to select suffix

	prompt_mssg="\nWould you like to:\n  [1] Create plaintext file
	\r  [2] Choose file suffix/extension"

	echo -e "$prompt_mssg"
	read  -e -n 1 -rp " >> " choice
	case "$choice" in
		1 | "")
			return 1
			;;
		2)
			return 2
			;;
		*)
			echo -e "$RED\rPlease choose 1 or 2.$WHITE"
			no_template
			;;
	esac

	return "$choice"
}


locate_template() {
	# find file end with specific extension/suffix
	#
	# Returns: (string)
	# 		path to template

	local src
	src=$(find "$TEMPLATE_DIR" -iregex ".*\.$1$")

	echo "$src"
}


cp_template() {
	# copy template file from Templates dir to destination
	#
	# Arguments
	# 	$1 path/to/new/file

	FILE=$1
	SUFFIX=$(basename "$FILE" | rev | cut -d "." -f1 | rev)
	SRC_FILE=$(locate_template "$SUFFIX")

	if [[ -n $SRC_FILE ]]; then
		cp "$SRC_FILE" "$1"
	else
		echo -n "unknown/no suffix for file $FILE"
		no_template
		case "$?" in
			1)
				touch "$FILE"
				;;
			2)
				FILE=$(select_suffix "$FILE")
				touch "$FILE"
				;;
		esac
	fi

	edit_template "$FILE"
}


edit_template() {
	# replace PROG with program name in file begging comment (e.g docstring)
	#
	# Arguments:
	#	$1: path to file

	prog_name=$(basename "$1")
	sed -i "s/PROG/$prog_name/g" "$1"
}


main() {
	check_templates

	while getopts ":h" opt; do
		case "$opt" in
			'h' )
				_help
				exit 0
				;;
			* )
				echo "Invalid option: -$OPTARG" >&2
				usage >&2
				exit 1
				;;
		esac
	done
	shift $((OPTIND-1))

	for i in "$@"; do
		cp_template "$i"
	done
}


PROG=$(basename "$0")
RED="\033[91m"
WHITE="\033[m"
TEMPLATE_DIR="$HOME/Templates/"

if [ "$BASH_SOURCE" == "$0" ]; then
	if [[ "$#" -eq 0 ]]; then
		echo -e "Err: No Argument(s)" >&2
		usage >&2
		exit 1
	fi

	main "$@"
fi
